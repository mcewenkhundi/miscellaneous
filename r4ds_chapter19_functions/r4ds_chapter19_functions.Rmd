---
title: "R4ds book club"

subtitle: "Chapter19 Functions"

author: |
  | McEwen Khundi
  |
  | London School of Hygiene & Tropical Medicine, London, UK
  | Malawi-Liverpool-Wellcome Clinical Research Programme, Blantyre, Malawi
  |

date: | 
  | `r format(Sys.time(), "%B %d, %Y")`
  |
  | Table of Contents:
output: 
  html_document:
    df_print: paged
    theme: spacelab
    toc: true
---

<br>

## 1. Backgound

<br>

## 2. Set-up

Load all required packages for analysis.

```{r setup, message=FALSE}
library(tidyverse)    #for data manipulation
library(knitr)        #for tables

```

<br>

## 3. Import datasets

Import data required for the analysis.

We will use the penguis data set

```{r import}
#install.packages("palmerpenguins")
library(palmerpenguins)


penguins

#save a copy of original df
penguins_o <- penguins
```

<br>

## 4. Functions ?

-   Makes code easier to read

-   Helps code to be concise, you only need to update code in only one place

-   Reduce the chance of making mistakes

### 5. Task to demonstrate the importance of functions (Standardization/Scaling)

-   Necessary when continuous independent variables are measured at different scales

-   The idea is to rescale variables to have equal range or variance

```{r tidy}

View(penguins)
penguins %>%
summarise(bill_length_mm = mean(bill_length_mm, na.rm = TRUE),
            bill_depth_mm = mean(bill_depth_mm, na.rm = TRUE),
            flipper_length_mm = mean(flipper_length_mm, na.rm = TRUE),
            body_mass_g = mean(body_mass_g,, na.rm = TRUE))


```

### 6. Rescaling by Z scores

-   Subtract each value by mean and devide by std.dev

```{r}

penguins$bill_length_mm <- (penguins$bill_length_mm - mean(penguins$bill_length_mm, na.rm = TRUE))/sd(penguins$bill_length_mm, na.rm = TRUE)

penguins$bill_depth_mm <- (penguins$bill_depth_mm - mean(penguins$bill_depth_mm, na.rm = TRUE))/sd(penguins$bill_depth_mm, na.rm = TRUE)

penguins$flipper_length_mm <- (penguins$flipper_length_mm - mean(penguins$flipper_length_mm, na.rm = TRUE))/sd(penguins$flipper_length_mm, na.rm = TRUE)

penguins$body_mass_g <- (penguins$body_mass_g - mean(penguins$body_mass_g, na.rm = TRUE))/sd(penguins$body_mass_g, na.rm = TRUE)
```

### 7. First option for rescaling (Z score)

-   Define (Z score) function in R

```{r}
rescale_meansd <- function (x) {
  (x-mean(x,na.rm = TRUE))/sd(x, na.rm = TRUE)
}
```

```{r}
penguins <- palmerpenguins::penguins

penguins$bill_length_mm <- rescale_meansd(penguins$bill_length_mm)
penguins$bill_depth_mm <- rescale_meansd(penguins$bill_depth_mm)
penguins$flipper_length_mm <- rescale_meansd(penguins$flipper_length_mm )
penguins$body_mass_g <- rescale_meansd(penguins$body_mass_g)

penguins
```

### 8. Adding some tests (Z score)

-   Defensive programming

-   What happens when we use the function on a character variable

```{r}
penguins <- palmerpenguins::penguins

rescale_meansd(penguins$species)

```

```{r}
rescale_meansd <- function (x) {
  if(is.numeric(x) != TRUE){
    stop("X must be numeric", call. = FALSE)
  }

  (x-mean(x,na.rm = TRUE))/sd(x, na.rm = TRUE)
}



```

```{r}
rescale_meansd(penguins$species)

class(penguins$species)
```

### Lets check if it is still working

```{r}
rescale_meansd(penguins$bill_length_mm)

```

### 9. Passing arguments arguments (Z score)

-   Passing arguments to other functions

-   Reading error messages

```{r}
rescale_meansd <- function (x, missing = TRUE) {
  if(is.numeric(x) != TRUE){
    stop("X must be numeric", call. = FALSE)
  }

  (x-mean(x, na.rm=missing))/sd(x, na.rm=missing)
}

```

```{r}
rescale_meansd(penguins$bill_length_mm)

```

### 9. Setting default values to arguments (Z score)

```{r}
rescale_meansd <- function (x, missing = TRUE) {
  if(is.numeric(x) != TRUE){
    stop("X must be numeric", call. = FALSE)
  }

  (x-mean(x, na.rm=missing))/sd(x, na.rm=missing)
}
```

```{r}
rescale_meansd(penguins$bill_length_mm)
```

### 10. Another example for setting up functions

Using a scatter plot investigate the relationship between flipper_length_mm and body_mass_g separately for each island

```{r}
# Biscoe, Dream, Torgersen
unique(penguins$island)

#Create the three datasets for each island
penguins_Biscoe <- penguins %>%
                   filter(island=="Biscoe")

penguins_Dream <- penguins %>%
                   filter(island=="Dream")

penguins_Torgersen <- penguins %>%
                   filter(island=="Torgersen")

#unique(penguins_Biscoe$island)

```

### Steps in developing a function

-   Based on the code below identify which parts are changing and which are constant.

-   The changing parts will be parsed as arguments.

-   The constant parts will be set as defaults since their is not need to change them

-   N.B. Missing variables are ignored by default in ggplot2 but with a warning message unlike in function mean() and sd() above.


```{r}
ggplot(data = penguins_Biscoe, mapping = aes(x= body_mass_g, y = flipper_length_mm )) +
  geom_point() +
  geom_smooth(method = "lm", se=FALSE)


ggplot(data = penguins_Dream, mapping = aes(x=body_mass_g , y =  flipper_length_mm)) +
  geom_point() +
  geom_smooth(method = "lm", se=FALSE)

ggplot(data = penguins_Torgersen, mapping = aes(x= body_mass_g , y = flipper_length_mm )) +
  geom_point() +
  geom_smooth(method = "lm", se=FALSE)
```

```{r}
scatter_mass_flipper_length <- function(data_df) {
   ggplot(data = data_df, mapping = aes(x= flipper_length_mm, y = body_mass_g)) +
  geom_point() +
  geom_smooth(method = "lm", se=FALSE) + 
  labs(x = "Body mass in grams", y = "Flipper length in mm")
 }


```

# How can we improve the functions
Maybe allow an argument for titles ?
```{r}
scatter_mass_flipper_length(penguins_Biscoe)
scatter_mass_flipper_length(penguins_Dream)
scatter_mass_flipper_length(penguins_Torgersen)
```

```{r}
scatter_mass_flipper_length <- function(data_df, title_txt) {
   ggplot(data = penguins_Torgersen, mapping = aes(x= flipper_length_mm, y = body_mass_g)) +
  geom_point() +
  geom_smooth(method = "lm", se=FALSE) + 
  labs(x = "Body mass in grams", y = "Flipper length in mm", title = title_txt)
 }


```

# How can we improve the function
Maybe allow an argument for titles ?
```{r}
scatter_mass_flipper_length(penguins_Biscoe, title_txt = "Biscoe island: Penguin body mass (grams) vs flipper length")

scatter_mass_flipper_length(penguins_Dream, title_txt = "Dream island: Penguin body mass (grams) vs flipper length")

scatter_mass_flipper_length(penguins_Torgersen, title_txt = "Torgersen island:Penguin body mass (grams) vs flipper length")
```

# Any other improvement?
Maybe allow an argument for titles ?
Default title?

```{r}
scatter_mass_flipper_length(penguins)
```


```{r}
scatter_mass_flipper_length <- function(data_df, title_txt = "Penguin body mass (grams) vs flipper length") {
   ggplot(data = penguins_Torgersen, mapping = aes(x= flipper_length_mm, y = body_mass_g)) +
  geom_point() +
  geom_smooth(method = "lm", se=FALSE) + 
  labs(x = "Body mass in grams", y = "Flipper length in mm", title = title_txt)
 }


```

```{r}
scatter_mass_flipper_length(penguins)
```

### Customise the function to allow mass versus any other dependent numerical variables
-   Non standard evaluation (data-masking)

-   https://ggplot2.tidyverse.org/articles/ggplot2-in-packages.html

-   https://dplyr.tidyverse.org/articles/programming.html
```{r}

scatter_mass_numdep <- function(data_df,numdep ,title_txt, y_txt) {
   ggplot(data = penguins_Torgersen, mapping = aes(x= body_mass_g, y = {{numdep}})) +
  geom_point() +
  geom_smooth(method = "lm", se=FALSE) + 
  labs(x = "Body mass in grams", y = y_txt, title = title_txt)
 }
```

```{r}
scatter_mass_numdep(penguins, numdep = bill_length_mm, y_txt = "Bill length (mm)", title_txt = "Penguin body mass (g) vs Bill length (mm)" )
```

```{r}
scatter_mass_numdep <- function(data_df,numdep , y_txt= "Bill length (mm)") {
   ggplot(data = penguins_Torgersen, mapping = aes(x= flipper_length_mm, y = {{numdep}})) +
  geom_point() +
  geom_smooth(method = "lm", se=FALSE) + 
  labs(x = "Body mass in grams", y = y_txt, title = glue::glue("Penguin body mass (g) vs {y_txt}"))
 }
```

```{r}
scatter_mass_numdep(penguins, numdep = bill_length_mm, y_txt = "Bill length (mm)")

scatter_mass_numdep
```


### 10 References

-   [More on the data Penguins](https://twitter.com/allison_horst/status/1287772985630191617)

-   [Chapter 19 functions](https://r4ds.had.co.nz/functions.html)

<br>

## X. Reproducibility

This reproduction of the analysis was run by:

```{r sysinfo, echo=FALSE, message=FALSE, comment=NA, warning=FALSE}

sysinfo <- Sys.info()

sysinfo <- data.frame(keyName=names(sysinfo), value=sysinfo, row.names=NULL)

sysinfo %>% kable()
```

Analysis was run at **`r Sys.time()`**, and using the following Session Info:

```{r sessioninfo, echo=FALSE, results='markdown', message=FALSE, comment=NA, warning=FALSE}
sessionInfo()
```
